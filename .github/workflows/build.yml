name: Oasis Final Build
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ๐ Checkout repository
        uses: actions/checkout@v4

      - name: ๐ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ๐ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ๐ฆ Match Credentials & Prep
        run: |
          cd mobile
          # ุญู ูุดููุฉ ุงูุชุนุงุฑุถุงุช ุงูุนุงูููุฉ ูููุน ุชููู ุงูุจูุงุก
          echo "legacy-peer-deps=true" > .npmrc
          
          # ุชุฃููู ูููุฉ ุงูุชุทุจูู ูุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ูุชุดูู ุงูุชุฑุงุฎูุต ุงููุทููุจุฉ ูู App.js
          echo '{
            "expo": {
              "name": "Oasis",
              "slug": "oasis-app",
              "version": "1.0.0",
              "owner": "aboahj",
              "android": {
                "package": "com.aboahj.oasisapp",
                "permissions": ["CAMERA", "RECORD_AUDIO", "POST_NOTIFICATIONS"]
              },
              "extra": {
                "eas": {
                  "projectId": "742d678c-90bd-4cf1-b261-604691b3cf53"
                }
              }
            }
          }' > app.json
          
          npm pkg delete type
          
          # [ุฅุตูุงุญ ุฃุฎุทุงุก ุงูุตูุฑ 1000079056 ู 1000079058]
          # ุชุซุจูุช ุงูููุชุจุงุช ุงูุฃุณุงุณูุฉ ุงูููููุฏุฉ ุงูุชู ูุญุชุงุฌูุง ูุญุฑู Gradle ู Kotlin ููุชุนุงูู ูุน ุงูุฅุถุงูุงุช
          npm install @expo/config-plugins @expo/prebuild-config expo-modules-core --save --legacy-peer-deps
          
          # ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ ูุนูู ุงูุฅุดุนุงุฑุงุช ูุงูุงุชุตุงู ูุงูุชุดููุฑ ูู App.js
          npm install expo-notifications expo-device expo-constants crypto-js react-delegate-component --save --legacy-peer-deps
          npm install @zegocloud/zego-uikit-prebuilt-call-rn zego-zim-react-native zego-zpns-react-native --save --legacy-peer-deps
          
          # ุงูุชุซุจูุช ุงูููุงุฆู ุงูุดุงูู ููุงูุฉ ุงูุชุจุนูุงุช
          npm install --legacy-peer-deps
          
          # ุฅุตูุงุญ ุชุนุงุฑุถ ุงูุฃุณูุงุก ูู ุฃูุฏุฑููุฏ ูุถูุงู ุนุจูุฑ ูุฑุญูุฉ ุงูุชุฌููุน ุงูููุงุฆู (Gradle)
          find node_modules -name "AndroidManifest.xml" -exec sed -i 's/package="com.zegouikitrebuiltcallrn"/ /g' {} + || true
          
          # ุฅุตูุงุญุงุช ุงูุฃุฎุทุงุก ุงูุจุฑูุฌูุฉ ุฏุงุฎู ููุชุจุงุช Zego ูุถูุงู ุงูุชูุงูู ูุน React Native ุงูุญุฏูุซ
          find node_modules -name "index.js" -path "*zegocloud*" -exec sed -i "s/import { typeof } from 'react-native';/import { } from 'react-native';/g" {} + || true

      - name: ๐ Build APK (Final Fix & Clear Cache)
        run: |
          cd mobile
          # ุฅุฌุจุงุฑ ุงูุณูุฑูุฑ ุนูู ุชุฌุงูู ุชุนุงุฑุถุงุช ุงูุฅุตุฏุงุฑุงุช ุฃุซูุงุก ุงูุชุฌููุน
          export NPM_CONFIG_LEGACY_PEER_DEPS=true
          # ุงุณุชุฎุฏุงู --clear-cache ููุณุญ ุจูุงูุง ุงูุจูุงุก ุงููุงุดู ูุถูุงู ุจูุงุก ูุธูู ุชูุงูุงู
          npx eas-cli build --platform android --profile preview --non-interactive --clear-cache
